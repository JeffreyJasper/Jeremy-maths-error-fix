<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jeremy 算柱特訓：位值大挑戰</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f0f9ff;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .abacus-bead {
            width: 40px;
            height: 24px;
            background: radial-gradient(circle at 30% 30%, #fbbf24, #d97706);
            border-radius: 50%;
            margin-bottom: 4px;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .abacus-rod {
            width: 6px;
            height: 180px;
            background-color: #94a3b8;
            border-radius: 4px;
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            z-index: 0;
        }
        .abacus-base {
            height: 12px;
            background-color: #475569;
            border-radius: 4px;
            width: 100%;
            margin-top: -6px;
            z-index: 20;
            position: relative;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { Trophy, RefreshCcw, CheckCircle2, AlertCircle, ArrowRight, BrainCircuit } = lucide;

        // --- 算柱組件 ---
        const Abacus = ({ tens, ones, label, highlight }) => {
            return (
                <div className={`flex flex-col items-center p-6 bg-white rounded-3xl border-4 transition-all ${highlight ? 'border-indigo-400 shadow-xl scale-105' : 'border-slate-200 shadow-sm'}`}>
                    <div className="flex gap-8 mb-2">
                        {/* 十位 */}
                        <div className="relative w-12 h-48 flex flex-col justify-end items-center">
                            <div className="abacus-rod"></div>
                            <div className="z-10 flex flex-col-reverse mb-1">
                                {[...Array(tens)].map((_, i) => (
                                    <div key={`t-${i}`} className="abacus-bead"></div>
                                ))}
                            </div>
                            <div className="absolute -bottom-8 font-black text-slate-500 text-sm">十位</div>
                        </div>

                        {/* 個位 */}
                        <div className="relative w-12 h-48 flex flex-col justify-end items-center">
                            <div className="abacus-rod"></div>
                            <div className="z-10 flex flex-col-reverse mb-1">
                                {[...Array(ones)].map((_, i) => (
                                    <div key={`o-${i}`} className="abacus-bead"></div>
                                ))}
                            </div>
                            <div className="absolute -bottom-8 font-black text-slate-500 text-sm">個位</div>
                        </div>
                    </div>
                    <div className="abacus-base"></div>
                    <div className="mt-8 font-black text-2xl bg-slate-100 px-4 py-1 rounded-full text-slate-600">
                        {label}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [stage, setStage] = useState('menu'); // menu, quiz, result
            const [score, setScore] = useState(0);
            const [qCount, setQCount] = useState(0);
            const [currentQ, setCurrentQ] = useState(null);
            const [feedback, setFeedback] = useState(null); // null, correct, wrong
            const [history, setHistory] = useState([]);

            const TOTAL_QUESTIONS = 10;

            // 生成題目的邏輯
            const generateQuestion = () => {
                const type = Math.random() > 0.4 ? 'COMPARE' : 'READ'; // 60% 比較題，40% 讀數題
                let q = { type, id: Date.now() };

                if (type === 'COMPARE') {
                    // 針對 Jeremy 的弱點：生成容易混淆的對比
                    // 例如：20 vs 12 (看起來 12 珠子多), 52 vs 25 (數字倒轉)
                    const patterns = [
                        { t1: 2, o1: 0, t2: 1, o2: 2 }, // 20 vs 12 (陷阱：B珠子多但值小)
                        { t1: 1, o1: 0, t2: 0, o2: 9 }, // 10 vs 9 (陷阱：B珠子超多)
                        { t1: 5, o1: 2, t2: 2, o2: 5 }, // 52 vs 25 (倒轉)
                        { t1: 3, o1: 1, t2: 1, o2: 3 }, // 31 vs 13
                        { t1: 4, o1: 0, t2: 0, o2: 4 }, // 40 vs 4
                    ];
                    
                    // 隨機選一個模式或生成隨機數
                    let p;
                    if (Math.random() > 0.3) {
                        p = patterns[Math.floor(Math.random() * patterns.length)];
                    } else {
                        p = { 
                            t1: Math.floor(Math.random() * 5), o1: Math.floor(Math.random() * 9),
                            t2: Math.floor(Math.random() * 5), o2: Math.floor(Math.random() * 9)
                        };
                        // 確保兩數不相等
                        while (p.t1 * 10 + p.o1 === p.t2 * 10 + p.o2) {
                            p.t2 = Math.floor(Math.random() * 5);
                        }
                    }

                    // 隨機決定 A 或 B 較大
                    const valA = p.t1 * 10 + p.o1;
                    const valB = p.t2 * 10 + p.o2;
                    
                    q.data = { A: { t: p.t1, o: p.o1, v: valA }, B: { t: p.t2, o: p.o2, v: valB } };
                    q.text = "哪個算柱表示的數比較大？";
                    q.correct = valA > valB ? 'A' : 'B';
                } else {
                    // 讀數題
                    const t = Math.floor(Math.random() * 6); // 0-5 (不超過50以符合小一上)
                    const o = Math.floor(Math.random() * 10);
                    // 強制出現 0 的情況
                    const finalO = Math.random() > 0.7 ? 0 : o;
                    
                    q.data = { A: { t: t, o: finalO, v: t * 10 + finalO } };
                    q.text = "這個算柱表示的數是多少？";
                    
                    // 生成選項
                    const correct = q.data.A.v;
                    let opts = new Set([correct]);
                    opts.add(finalO * 10 + t); // 倒轉陷阱 (如 25 -> 52)
                    opts.add(correct + 1);
                    opts.add(correct + 10);
                    opts.add(t + finalO); // 加起來陷阱
                    
                    // 轉為陣列並打亂，過濾掉不合理數字
                    let options = Array.from(opts).filter(n => n >= 0 && n < 100).slice(0, 4);
                    // 補足 4 個選項
                    while(options.length < 4) {
                        let r = Math.floor(Math.random() * 50);
                        if (!options.includes(r)) options.push(r);
                    }
                    
                    q.options = options.sort(() => Math.random() - 0.5);
                    q.correct = correct;
                }

                setCurrentQ(q);
                setFeedback(null);
            };

            const startQuiz = () => {
                setScore(0);
                setQCount(0);
                setHistory([]);
                setStage('quiz');
                generateQuestion();
            };

            const handleAnswer = (ans) => {
                if (feedback) return;

                const isCorrect = ans.toString() === currentQ.correct.toString();
                if (isCorrect) setScore(s => s + 1);
                
                setFeedback(isCorrect ? 'correct' : 'wrong');
                
                // 記錄錯題
                setHistory(prev => [...prev, { ...currentQ, userAns: ans, isCorrect }]);

                setTimeout(() => {
                    if (qCount >= TOTAL_QUESTIONS - 1) {
                        setStage('result');
                    } else {
                        setQCount(c => c + 1);
                        generateQuestion();
                    }
                }, 1500); // 延長顯示時間讓小朋友看清楚
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-4">
                    {stage === 'menu' && (
                        <div className="bg-white p-10 rounded-[3rem] shadow-xl text-center max-w-md w-full border-t-8 border-indigo-500">
                            <div className="bg-indigo-100 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6">
                                <BrainCircuit size={48} className="text-indigo-600" />
                            </div>
                            <h1 className="text-3xl font-black text-slate-800 mb-4">算柱位值大挑戰</h1>
                            <p className="text-slate-500 font-bold mb-8">
                                專攻 Jeremy 的弱點：<br/>
                                ⚠️ 小心十位和個位倒轉！<br/>
                                ⚠️ 空位代表 0，不要數漏！
                            </p>
                            <button onClick={startQuiz} className="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black text-2xl shadow-lg active:scale-95 transition-all">
                                開始特訓
                            </button>
                        </div>
                    )}

                    {stage === 'quiz' && currentQ && (
                        <div className="w-full max-w-lg">
                            <div className="flex justify-between items-center mb-6 px-4">
                                <span className="bg-white px-4 py-2 rounded-xl font-black text-slate-400 border border-slate-200">
                                    題號 {qCount + 1} / {TOTAL_QUESTIONS}
                                </span>
                                <div className="flex items-center gap-2 text-amber-500 font-black text-xl">
                                    <Trophy size={24} /> {score * 10}
                                </div>
                            </div>

                            <div className="bg-white p-8 rounded-[3rem] shadow-lg border border-slate-100 text-center relative overflow-hidden">
                                {feedback && (
                                    <div className={`absolute inset-0 flex flex-col items-center justify-center z-20 ${feedback === 'correct' ? 'bg-green-500/95' : 'bg-red-500/95'} text-white animate-in fade-in duration-200`}>
                                        {feedback === 'correct' ? (
                                            <>
                                                <CheckCircle2 size={64} className="mb-4" />
                                                <h2 className="text-4xl font-black">答對了！</h2>
                                            </>
                                        ) : (
                                            <>
                                                <AlertCircle size={64} className="mb-4" />
                                                <h2 className="text-4xl font-black mb-2">哎呀！</h2>
                                                <p className="text-xl font-bold">
                                                    {currentQ.type === 'COMPARE' 
                                                        ? `記得先看十位！${currentQ.data[currentQ.correct].v} 比較大` 
                                                        : `正確答案是 ${currentQ.correct}`}
                                                </p>
                                            </>
                                        )}
                                    </div>
                                )}

                                <h2 className="text-2xl font-black text-slate-800 mb-8">{currentQ.text}</h2>

                                {currentQ.type === 'COMPARE' ? (
                                    <div className="grid grid-cols-2 gap-4 mb-8">
                                        <button onClick={() => handleAnswer('A')} className="active:scale-95 transition-transform">
                                            <Abacus tens={currentQ.data.A.t} ones={currentQ.data.A.o} label="算柱 A" highlight={feedback && currentQ.correct === 'A'} />
                                        </button>
                                        <button onClick={() => handleAnswer('B')} className="active:scale-95 transition-transform">
                                            <Abacus tens={currentQ.data.B.t} ones={currentQ.data.B.o} label="算柱 B" highlight={feedback && currentQ.correct === 'B'} />
                                        </button>
                                    </div>
                                ) : (
                                    <div className="flex justify-center mb-8">
                                        <Abacus tens={currentQ.data.A.t} ones={currentQ.data.A.o} label="?" />
                                    </div>
                                )}

                                {currentQ.type === 'READ' && (
                                    <div className="grid grid-cols-2 gap-4">
                                        {currentQ.options.map((opt, i) => (
                                            <button 
                                                key={i} 
                                                onClick={() => handleAnswer(opt)}
                                                className="bg-slate-50 border-2 border-slate-200 hover:border-indigo-400 hover:bg-indigo-50 py-4 rounded-2xl text-3xl font-black text-indigo-900 transition-all active:scale-95"
                                            >
                                                {opt}
                                            </button>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {stage === 'result' && (
                        <div className="bg-white p-12 rounded-[3rem] shadow-2xl text-center max-w-md w-full border-t-8 border-amber-500 animate-in zoom-in duration-300">
                            <Trophy size={80} className="text-yellow-400 mx-auto mb-6 animate-bounce" />
                            <h2 className="text-4xl font-black text-slate-800 mb-2">特訓完成！</h2>
                            <p className="text-slate-500 font-bold mb-8">你的位值感越來越強了！</p>
                            
                            <div className="bg-indigo-50 rounded-3xl p-6 mb-8">
                                <div className="text-sm font-black text-indigo-400 uppercase tracking-widest mb-1">最終得分</div>
                                <div className="text-6xl font-black text-indigo-600">{score * 10}</div>
                            </div>

                            <button onClick={startQuiz} className="w-full bg-slate-900 text-white py-5 rounded-2xl font-black text-xl flex items-center justify-center gap-2 shadow-xl active:scale-95 transition-all">
                                <RefreshCcw size={20} /> 再做一次
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
